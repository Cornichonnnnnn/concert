#! python

import logging
import argparse
import quantities as q
from gi.repository import Ufo, Uca
from control.feedback.optimization import Maximizer
from control.devices.axes.crio import LinearAxis
from control.processes.gradientmaximizer import GradientMaximizer


if __name__ == '__main__':
    config = Ufo.Config(paths=['/home/matthias/dev/ufo-filters/build/src'])

    parser = argparse.ArgumentParser(description='Run autofocus procedure')
    parser.add_argument('--camera', type=str, default='mock',
                        help='libuca camera identifier')

    args = parser.parse_args()

    logger = logging.getLogger()
    logger.addHandler(logging.StreamHandler())
    logger.setLevel(logging.INFO)

    pm = Uca.PluginManager()
    camera = pm.get_camera(args.camera)

    sharpness = Maximizer()
    axis = LinearAxis()

    limits = (0 * q.mm, 2 * q.mm)
    focus = GradientMaximizer(camera, sharpness, axis, limits, config)
    focus.start()
